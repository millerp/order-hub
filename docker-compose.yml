x-laravel-service: &laravel-service
  build:
    context: .
    dockerfile: Dockerfile
    args:
      - USER_ID=${CURRENT_UID:-1000}
      - GROUP_ID=${CURRENT_GID:-1000}
  user: "${CURRENT_UID:-1000}:${CURRENT_GID:-1000}"
  networks:
    - orderhub-network
  depends_on:
    - kafka
    - redis

services:
  # Message Broker
  kafka:
    image: apache/kafka:latest
    container_name: orderhub-kafka
    ports:
      - "9092:9092"
    environment:
      - KAFKA_NODE_ID=1
      - KAFKA_PROCESS_ROLES=broker,controller
      - KAFKA_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092
      - KAFKA_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      - KAFKA_CONTROLLER_QUORUM_VOTERS=1@kafka:9093
      - KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1
      - KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR=1
      - KAFKA_TRANSACTION_STATE_LOG_MIN_ISR=1
    networks:
      - orderhub-network

  # Cache
  redis:
    image: redis:alpine
    container_name: orderhub-redis
    ports:
      - "6379:6379"
    networks:
      - orderhub-network

  # Databases (One per service)
  auth-db:
    image: mysql:8.4
    container_name: orderhub-auth-db
    environment:
      - MYSQL_DATABASE=auth_service
      - MYSQL_ROOT_PASSWORD=secret
    ports:
      - "33061:3306"
    networks:
      - orderhub-network

  user-db:
    image: mysql:8.4
    container_name: orderhub-user-db
    environment:
      - MYSQL_DATABASE=user_service
      - MYSQL_ROOT_PASSWORD=secret
    ports:
      - "33062:3306"
    networks:
      - orderhub-network

  product-db:
    image: mysql:8.4
    container_name: orderhub-product-db
    environment:
      - MYSQL_DATABASE=product_service
      - MYSQL_ROOT_PASSWORD=secret
    ports:
      - "33063:3306"
    networks:
      - orderhub-network

  order-db:
    image: mysql:8.4
    container_name: orderhub-order-db
    environment:
      - MYSQL_DATABASE=order_service
      - MYSQL_ROOT_PASSWORD=secret
    ports:
      - "33064:3306"
    networks:
      - orderhub-network

  payment-db:
    image: mysql:8.4
    container_name: orderhub-payment-db
    environment:
      - MYSQL_DATABASE=payment_service
      - MYSQL_ROOT_PASSWORD=secret
    ports:
      - "33065:3306"
    networks:
      - orderhub-network

  notification-db:
    image: mysql:8.4
    container_name: orderhub-notification-db
    environment:
      - MYSQL_DATABASE=notification_service
      - MYSQL_ROOT_PASSWORD=secret
    ports:
      - "33066:3306"
    networks:
      - orderhub-network

  # Laravel Services
  auth-service:
    <<: *laravel-service
    container_name: orderhub-auth-service
    volumes:
      - ./auth-service:/app
    ports:
      - "8001:8000"
    depends_on:
      - auth-db

  user-service:
    <<: *laravel-service
    container_name: orderhub-user-service
    volumes:
      - ./user-service:/app
      - ./auth-service/storage/oauth-public.key:/app/storage/oauth-public.key:ro
    ports:
      - "8002:8000"
    depends_on:
      - user-db

  product-service:
    <<: *laravel-service
    container_name: orderhub-product-service
    volumes:
      - ./product-service:/app
      - ./auth-service/storage/oauth-public.key:/app/storage/oauth-public.key:ro
    ports:
      - "8003:8000"
    depends_on:
      - product-db

  order-service:
    <<: *laravel-service
    container_name: orderhub-order-service
    volumes:
      - ./order-service:/app
      - ./auth-service/storage/oauth-public.key:/app/storage/oauth-public.key:ro
    ports:
      - "8004:8000"
    depends_on:
      - order-db

  payment-service:
    <<: *laravel-service
    container_name: orderhub-payment-service
    volumes:
      - ./payment-service:/app
      - ./auth-service/storage/oauth-public.key:/app/storage/oauth-public.key:ro
    ports:
      - "8005:8000"
    depends_on:
      - payment-db

  notification-service:
    <<: *laravel-service
    container_name: orderhub-notification-service
    volumes:
      - ./notification-service:/app
      - ./auth-service/storage/oauth-public.key:/app/storage/oauth-public.key:ro
    ports:
      - "8006:8000"
    depends_on:
      - notification-db

  # API Gateway + Frontend SPA
  gateway:
    build:
      context: .
      dockerfile: gateway/Dockerfile
      args:
        - USER_ID=${CURRENT_UID:-1000}
        - GROUP_ID=${CURRENT_GID:-1000}
    user: "${CURRENT_UID:-1000}:${CURRENT_GID:-1000}"
    container_name: orderhub-gateway
    volumes:
      - ./frontend:/app/frontend
      - ./gateway/nginx.conf:/etc/nginx/nginx.conf
    ports:
      - "80:80"
    networks:
      - orderhub-network
    depends_on:
      - auth-service
      - user-service
      - product-service
      - order-service

networks:
  orderhub-network:
    driver: bridge
