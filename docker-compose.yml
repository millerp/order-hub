x-laravel-service: &laravel-service
  build:
    context: .
    dockerfile: Dockerfile
    args:
      - USER_ID=${CURRENT_UID:-1000}
      - GROUP_ID=${CURRENT_GID:-1000}
  user: "${CURRENT_UID:-1000}:${CURRENT_GID:-1000}"
  networks:
    - orderhub-network
  depends_on:
    - kafka
    - redis

services:
  # Message Broker
  kafka:
    image: apache/kafka:latest
    container_name: orderhub-kafka
    ports:
      - "9092:9092"
    environment:
      - KAFKA_NODE_ID=1
      - KAFKA_PROCESS_ROLES=broker,controller
      - KAFKA_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092
      - KAFKA_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      - KAFKA_CONTROLLER_QUORUM_VOTERS=1@kafka:9093
      - KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1
      - KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR=1
      - KAFKA_TRANSACTION_STATE_LOG_MIN_ISR=1
    healthcheck:
      test: ["CMD-SHELL", "/opt/kafka/bin/kafka-topics.sh --bootstrap-server localhost:9092 --list >/dev/null 2>&1"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 20s
    networks:
      - orderhub-network

  # Cache
  redis:
    image: redis:alpine
    container_name: orderhub-redis
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 12
    networks:
      - orderhub-network

  # Kafka UI
  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: orderhub-kafka-ui
    ports:
      - "8080:8080"
    environment:
      - KAFKA_CLUSTERS_0_NAME=local
      - KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS=kafka:9092
      - KAFKA_CLUSTERS_0_METRICS_PORT=9997
    networks:
      - orderhub-network
    depends_on:
      - kafka
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O /dev/null http://localhost:8080/actuator/health || wget -q -O /dev/null http://localhost:8080/"]
      interval: 15s
      timeout: 5s
      retries: 12
      start_period: 30s

  # Databases (One per service)
  auth-db:
    image: mysql:8.4
    container_name: orderhub-auth-db
    environment:
      - MYSQL_DATABASE=auth_service
      - MYSQL_ROOT_PASSWORD=secret
    ports:
      - "33061:3306"
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -uroot -p$$MYSQL_ROOT_PASSWORD --silent"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 20s
    networks:
      - orderhub-network

  user-db:
    image: mysql:8.4
    container_name: orderhub-user-db
    environment:
      - MYSQL_DATABASE=user_service
      - MYSQL_ROOT_PASSWORD=secret
    ports:
      - "33062:3306"
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -uroot -p$$MYSQL_ROOT_PASSWORD --silent"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 20s
    networks:
      - orderhub-network

  product-db:
    image: mysql:8.4
    container_name: orderhub-product-db
    environment:
      - MYSQL_DATABASE=product_service
      - MYSQL_ROOT_PASSWORD=secret
    ports:
      - "33063:3306"
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -uroot -p$$MYSQL_ROOT_PASSWORD --silent"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 20s
    networks:
      - orderhub-network

  order-db:
    image: mysql:8.4
    container_name: orderhub-order-db
    environment:
      - MYSQL_DATABASE=order_service
      - MYSQL_ROOT_PASSWORD=secret
    ports:
      - "33064:3306"
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -uroot -p$$MYSQL_ROOT_PASSWORD --silent"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 20s
    networks:
      - orderhub-network

  payment-db:
    image: mysql:8.4
    container_name: orderhub-payment-db
    environment:
      - MYSQL_DATABASE=payment_service
      - MYSQL_ROOT_PASSWORD=secret
    ports:
      - "33065:3306"
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -uroot -p$$MYSQL_ROOT_PASSWORD --silent"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 20s
    networks:
      - orderhub-network

  notification-db:
    image: mysql:8.4
    container_name: orderhub-notification-db
    environment:
      - MYSQL_DATABASE=notification_service
      - MYSQL_ROOT_PASSWORD=secret
    ports:
      - "33066:3306"
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -uroot -p$$MYSQL_ROOT_PASSWORD --silent"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 20s
    networks:
      - orderhub-network

  # Laravel Services
  auth-service:
    <<: *laravel-service
    container_name: orderhub-auth-service
    volumes:
      - ./auth-service:/app
    ports:
      - "8001:8000"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:8000/up >/dev/null || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 12
      start_period: 30s
    depends_on:
      - auth-db

  user-service:
    <<: *laravel-service
    container_name: orderhub-user-service
    volumes:
      - ./user-service:/app
      - ./packages/orderhub-shared:/packages/orderhub-shared:ro
      - ./auth-service/storage/keys:/app/storage/keys:ro
    ports:
      - "8002:8000"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:8000/up >/dev/null || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 12
      start_period: 30s
    depends_on:
      - user-db

  product-service:
    <<: *laravel-service
    container_name: orderhub-product-service
    volumes:
      - ./product-service:/app
      - ./packages/orderhub-shared:/packages/orderhub-shared:ro
      - ./auth-service/storage/keys:/app/storage/keys:ro
    ports:
      - "8003:8000"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:8000/up >/dev/null || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 12
      start_period: 30s
    depends_on:
      - product-db

  order-service:
    <<: *laravel-service
    container_name: orderhub-order-service
    volumes:
      - ./order-service:/app
      - ./packages/orderhub-shared:/packages/orderhub-shared:ro
      - ./auth-service/storage/keys:/app/storage/keys:ro
    ports:
      - "8004:8000"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:8000/up >/dev/null || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 12
      start_period: 30s
    depends_on:
      - order-db

  payment-service:
    <<: *laravel-service
    container_name: orderhub-payment-service
    volumes:
      - ./payment-service:/app
      - ./packages/orderhub-shared:/packages/orderhub-shared:ro
      - ./auth-service/storage/keys:/app/storage/keys:ro
    ports:
      - "8005:8000"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:8000/up >/dev/null || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 12
      start_period: 30s
    depends_on:
      - payment-db

  notification-service:
    <<: *laravel-service
    container_name: orderhub-notification-service
    volumes:
      - ./notification-service:/app
      - ./packages/orderhub-shared:/packages/orderhub-shared:ro
      - ./auth-service/storage/keys:/app/storage/keys:ro
    ports:
      - "8006:8000"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:8000/up >/dev/null || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 12
      start_period: 30s
    depends_on:
      - notification-db

  # Kafka Consumers
  order-consumer:
    <<: *laravel-service
    container_name: orderhub-order-consumer
    volumes:
      - ./order-service:/app
      - ./packages/orderhub-shared:/packages/orderhub-shared:ro
      - ./auth-service/storage/keys:/app/storage/keys:ro
    command: php artisan kafka:consume-payment
    healthcheck:
      test: ["CMD-SHELL", "tr '\\0' ' ' </proc/1/cmdline | grep -q 'kafka:consume-payment'"]
      interval: 20s
      timeout: 5s
      retries: 6
      start_period: 20s
    depends_on:
      - kafka
      - order-db

  order-outbox-publisher:
    <<: *laravel-service
    container_name: orderhub-order-outbox-publisher
    volumes:
      - ./order-service:/app
      - ./packages/orderhub-shared:/packages/orderhub-shared:ro
      - ./auth-service/storage/keys:/app/storage/keys:ro
    command: php artisan kafka:publish-outbox
    healthcheck:
      test: ["CMD-SHELL", "tr '\\0' ' ' </proc/1/cmdline | grep -q 'kafka:publish-outbox'"]
      interval: 20s
      timeout: 5s
      retries: 6
      start_period: 20s
    depends_on:
      - kafka
      - order-db

  order-scheduler:
    <<: *laravel-service
    container_name: orderhub-order-scheduler
    volumes:
      - ./order-service:/app
      - ./packages/orderhub-shared:/packages/orderhub-shared:ro
      - ./auth-service/storage/keys:/app/storage/keys:ro
    command: php artisan schedule:work
    healthcheck:
      test: ["CMD-SHELL", "tr '\\0' ' ' </proc/1/cmdline | grep -q 'schedule:work'"]
      interval: 20s
      timeout: 5s
      retries: 6
      start_period: 20s
    depends_on:
      - order-db

  payment-consumer:
    <<: *laravel-service
    container_name: orderhub-payment-consumer
    volumes:
      - ./payment-service:/app
      - ./packages/orderhub-shared:/packages/orderhub-shared:ro
      - ./auth-service/storage/keys:/app/storage/keys:ro
    command: php artisan kafka:consume-order
    healthcheck:
      test: ["CMD-SHELL", "tr '\\0' ' ' </proc/1/cmdline | grep -q 'kafka:consume-order'"]
      interval: 20s
      timeout: 5s
      retries: 6
      start_period: 20s
    depends_on:
      - kafka
      - payment-db

  notification-consumer:
    <<: *laravel-service
    container_name: orderhub-notification-consumer
    volumes:
      - ./notification-service:/app
      - ./packages/orderhub-shared:/packages/orderhub-shared:ro
      - ./auth-service/storage/keys:/app/storage/keys:ro
    command: php artisan kafka:consume-payment-approved
    healthcheck:
      test: ["CMD-SHELL", "tr '\\0' ' ' </proc/1/cmdline | grep -q 'kafka:consume-payment-approved'"]
      interval: 20s
      timeout: 5s
      retries: 6
      start_period: 20s
    depends_on:
      - kafka
      - notification-db

  notification-scheduler:
    <<: *laravel-service
    container_name: orderhub-notification-scheduler
    volumes:
      - ./notification-service:/app
      - ./packages/orderhub-shared:/packages/orderhub-shared:ro
      - ./auth-service/storage/keys:/app/storage/keys:ro
    command: php artisan schedule:work
    healthcheck:
      test: ["CMD-SHELL", "tr '\\0' ' ' </proc/1/cmdline | grep -q 'schedule:work'"]
      interval: 20s
      timeout: 5s
      retries: 6
      start_period: 20s
    depends_on:
      - notification-db

  notification-horizon:
    <<: *laravel-service
    container_name: orderhub-notification-horizon
    volumes:
      - ./notification-service:/app
      - ./packages/orderhub-shared:/packages/orderhub-shared:ro
      - ./auth-service/storage/keys:/app/storage/keys:ro
    command: php artisan horizon
    healthcheck:
      test: ["CMD-SHELL", "tr '\\0' ' ' </proc/1/cmdline | grep -q 'artisan horizon'"]
      interval: 20s
      timeout: 5s
      retries: 6
      start_period: 20s
    depends_on:
      - redis
      - notification-db

  # API Gateway + Frontend SPA
  gateway:
    build:
      context: .
      dockerfile: gateway/Dockerfile
      args:
        - USER_ID=${CURRENT_UID:-1000}
        - GROUP_ID=${CURRENT_GID:-1000}
    user: "${CURRENT_UID:-1000}:${CURRENT_GID:-1000}"
    container_name: orderhub-gateway
    volumes:
      - ./frontend:/app/frontend
      - ./gateway/nginx.conf:/etc/nginx/nginx.conf
    ports:
      - "80:8080"
    networks:
      - orderhub-network
    depends_on:
      - auth-service
      - user-service
      - product-service
      - order-service
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O /dev/null http://127.0.0.1:8080/up || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 12
      start_period: 20s

networks:
  orderhub-network:
    driver: bridge
