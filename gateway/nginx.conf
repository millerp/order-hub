worker_processes auto;

events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # Rate limit: 30 req/s per IP, burst 10
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=30r/s;

    # --- Upstreams (internal Docker DNS) ---
    upstream auth_service    { server orderhub-auth-service:8000; }
    upstream user_service    { server orderhub-user-service:8000; }
    upstream product_service { server orderhub-product-service:8000; }
    upstream order_service   { server orderhub-order-service:8000; }

    server {
        listen 80;
        server_name _;
        server_tokens off;

        # Security headers
        add_header X-Frame-Options DENY always;
        add_header X-Content-Type-Options nosniff always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin" always;

        # CORS pre-flight for frontend
        add_header 'Access-Control-Allow-Origin'  '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, PATCH, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Accept' always;

        if ($request_method = OPTIONS) {
            return 204;
        }

        # --- Health check ---
        location = /up {
            proxy_pass http://auth_service/up;
        }

        # --- Auth Service (/api/v1/auth/* -> /api/v1/*) ---
        location ^~ /api/v1/auth {
            limit_req zone=api_limit burst=10 nodelay;
            rewrite ^/api/v1/auth(/.*)? /api/v1$1 break;
            proxy_pass         http://auth_service;
            proxy_set_header   Host              $host;
            proxy_set_header   X-Real-IP         $remote_addr;
            proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header   Authorization     $http_authorization;
        }

        # --- User Service ---
        location ^~ /api/v1/users {
            limit_req zone=api_limit burst=10 nodelay;
            proxy_pass         http://user_service;
            proxy_set_header   Host              $host;
            proxy_set_header   X-Real-IP         $remote_addr;
            proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header   Authorization     $http_authorization;
        }

        # --- Product Service ---
        location ^~ /api/v1/products {
            limit_req zone=api_limit burst=10 nodelay;
            proxy_pass         http://product_service;
            proxy_set_header   Host              $host;
            proxy_set_header   X-Real-IP         $remote_addr;
            proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header   Authorization     $http_authorization;
        }

        # --- Order Service ---
        location ^~ /api/v1/orders {
            limit_req zone=api_limit burst=10 nodelay;
            proxy_pass         http://order_service;
            proxy_set_header   Host              $host;
            proxy_set_header   X-Real-IP         $remote_addr;
            proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header   Authorization     $http_authorization;
        }

        # --- Frontend SPA (catch-all) ---
        location / {
            root   /usr/share/nginx/html;
            index  index.html;
            try_files $uri $uri/ /index.html;
        }
    }
}
